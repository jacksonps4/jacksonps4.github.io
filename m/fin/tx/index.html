<!DOCTYPE html>
<html lang="en">
<head>
    <title>Transactions</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <link href="https://fonts.googleapis.com/css?family=Special+Elite&display=swap" rel="stylesheet">

    <script src="jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>

    <!-- bootstrap -->
    <script src="bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>

    <!-- charts.js -->
    <script src="Chart.bundle.js"></script>
</head>
<body onload="init()">

<style>
    table tbody tr td, table thead tr th {
    }

    #monthly {
        max-width: 500px;
        max-height: 500px;
    }

    .sync {
        height: 18px;
        width: 18px;
    }

    #transactionPagination {
        float: right;
    }
</style>

<!--
integrity="sha384-uvr6jogqrjvABzptprq3UyhfHINHrHNGjraIm6JnEmumiZQslBfsEwkY2X+W4QqQ"
-->
<script src="fin-apis.js"
        crossorigin="use-credentials"></script>

<script>
    /*
     * TODO:
     *   - Add pagination to transaction feed page
     *     o Add page parameter to recent transaction endpoint
     *   - Add search to transaction feed page which updates charts
     *     o Add transaction search endpoint with pagination
     *     o Add pagination UI elements and bind
     *   - Encapsulate code here into class to avoid it being at the top-level in the DOM
     *   - Move document.getElementById calls outside of functions
     *   - Add expenses category and income/expense charts to transaction feed page
     *
     */
    const apis = new FinApis();

    function clearElement(el) {
        while (el.hasChildNodes()) {
            el.removeChild(el.lastChild);
        }
    }

    function init() {
        loadTransactions();
        loadMonthsDropDown();
        loadMonthlySpendingChart();
        bindRefreshButton();
        loadSpendingAnalysis();
    }

    function bindRefreshButton() {
        var refreshButton = document.getElementById('refresh');
        refreshButton.addEventListener('click', e => {
            loadTransactions();
        });
    }

    function loadTransactionPagination(currentPage, pagesAvailable) {
        var pagination = document.getElementById('transactionPagination');
        pagination.hidden = pagesAvailable && pagesAvailable.length == 0;

        function createPage(page, label) {
            let pageElement = document.createElement('li');
            pageElement.className = 'page-item';
            let pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '?page=' + page;
            if (currentPage === page) {
                pageElement.setAttribute('aria-current', 'page');
                pageElement.className = pageElement.className.concat(' active');
            }
            pageLink.appendChild(document.createTextNode(label ? label : page));
            pageElement.appendChild(pageLink);
            return pageElement;
        }

        var pages = document.getElementById('txPages');
        clearElement(pages);

        for (i = 0; i < pagesAvailable.length; i++) {
            pages.appendChild(createPage(i));
        }
    }

    function loadTransactions() {
        apis.getRecentTransactions(transactionResponse => {
            var recentTransactions = document.getElementById('transactions')
            clearElement(recentTransactions);

            let currentPage = transactionResponse.page;
            let pages = transactionResponse.pagesAvailable;
            loadTransactionPagination(currentPage, pages);

            let transactions = transactionResponse.results;
            if (transactions.length > 0) {
                document.getElementById('transactions').hidden = false;
            } else {
                document.getElementById('transactions').hidden = true;
            }

            transactions.forEach(transaction => {
                var date = document.createElement('td');
                date.appendChild(document.createTextNode(transaction.transactionTime));

                var detail = transaction.counterparty;

                var amount = document.createElement('td');
                var amt = transaction.amount.toFixed(2);
                if (amt < 0) {
                    amount.className += 'table-danger';
                }
                if (transaction.currency !== 'GBP') {

                }
                amount.appendChild(document.createTextNode(amt));

                var currency = document.createElement('td');
                currency.appendChild(document.createTextNode(transaction.currency));

                var spendingCategory = document.createElement('td');
                spendingCategory.appendChild(document.createTextNode(transaction.spendingCategory));

                var row = document.createElement("tr");
                if (transaction.status === 'PENDING') {
                    row.className += "table-secondary";
                }
                if (transaction.status === 'REVERSED') {
                    row.className += "table-info";
                }

                var txDetails = document.createElement('td');
                txDetails.appendChild(document.createTextNode(detail));

                var refresh = document.createElement('td');
                var refreshGlyph = document.createElement('img');
                refreshGlyph.setAttribute('class', 'sync');
                refreshGlyph.setAttribute('src', 'sync.png');
                refresh.appendChild(refreshGlyph);

                row.appendChild(date);
                row.appendChild(txDetails);
                row.appendChild(amount);
                row.appendChild(currency);
                row.appendChild(spendingCategory);
                row.appendChild(refresh);

                recentTransactions.appendChild(row);

                refresh.addEventListener('click', e => {
                    apis.requestTransactionUpdate(transaction.uid, tx => {
                        loadTransactions();
                    });
                });
            });
        });
    }

    function loadMonthsDropDown() {
        var monthsDropDown = document.getElementById("months");
        monthsDropDown.addEventListener('change', e => {
            var selectedPeriod = monthsDropDown.value;
            var selectedItem = selectedPeriod.split('-');
            var selectedMonth = selectedItem[1];
            var selectedYear = selectedItem[0];
            loadMonthlyChartForSpecificMonth(selectedMonth, selectedYear);
        });

        apis.getAvailableMonths(months => {
            months.forEach(m => {
                var option = document.createElement('option');
                option.value = m;
                option.appendChild(document.createTextNode(m));
                monthsDropDown.appendChild(option);
            });
        });
    }

    function createMonthlySpendingChart(labels, data) {
        var ctx = document.getElementById('monthlySpending');
        clearElement(ctx);
        var monthlySpending = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Amount',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 0, 0, 0.2)',
                        'rgba(255, 128, 0, 0.2)',
                        'rgba(255, 255, 0, 0.2)',
                        'rgba(128, 255, 0, 0.2)',
                        'rgba(0, 255, 0, 0.2)',
                        'rgba(0, 255, 128, 0.2)',
                        'rgba(0, 255, 255, 0.2)',
                        'rgba(0, 128, 255, 0.2)',
                        'rgba(128, 0, 255, 0.2)',
                        'rgba(127, 0, 255, 0.2)',
                        'rgba(255, 0, 255, 0.2)',
                        'rgba(255, 0, 127, 0.2)',
                        'rgba(128, 128, 128, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 0, 0, 1)',
                        'rgba(255, 128, 0, 1)',
                        'rgba(255, 255, 0, 1)',
                        'rgba(128, 255, 0, 1)',
                        'rgba(0, 255, 0, 1)',
                        'rgba(0, 255, 128, 1)',
                        'rgba(0, 255, 255, 1)',
                        'rgba(0, 128, 255, 1)',
                        'rgba(128, 0, 255, 1)',
                        'rgba(127, 0, 255, 1)',
                        'rgba(255, 0, 255, 1)',
                        'rgba(255, 0, 127, 1)',
                        'rgba(128, 128, 128, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
        return monthlySpending;
    };

    function loadMonthlySpendingCategoryChart(monthlySpending) {
        var spendingLabels = [];
        var spendingData = [];
        monthlySpending.spendingCategoryLineItems.forEach(item => {
            if (item.category !== 'INCOME') {
                spendingLabels.push(item.category);
                spendingData.push(item.amount * -1);
            }
        });
        createMonthlySpendingChart(spendingLabels, spendingData);
    }

    function loadMonthlyIncomeExpensesChart(monthlySpending) {
        var income = 0;
        var expenses = 0;
        monthlySpending.spendingCategoryLineItems.forEach(item => {
            if (item.amount < 0) {
                expenses += ( item.amount * -1 );
            } else {
                income += item.amount;
            }
        });
        createMonthlyIncomeExpenseChart(income, expenses)
    }

    function loadMonthlySpendingChart() {
        apis.getMonthlySpending(monthlySpending => {
            loadMonthlySpendingCategoryChart(monthlySpending);
            loadMonthlyIncomeExpensesChart(monthlySpending);
        });
    }

    function loadMonthlyChartForSpecificMonth(month, year) {
        apis.getMonthlySpendingForPeriod(month, year, monthlySpending => {
            loadMonthlySpendingCategoryChart(monthlySpending);
            loadMonthlyIncomeExpensesChart(monthlySpending);
        });
    }

    function createMonthlyIncomeExpenseChart(income, expenses) {
        var ctx = document.getElementById('monthlyIncomeExpense');
        clearElement(ctx);
        var monthlyIncomeExpense = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [ 'Income', 'Expenses' ],
                datasets: [{
                    label: 'Amount',
                    data: [ income, expenses ],
                    backgroundColor: [
                        'rgba(255, 0, 0, 0.2)',
                        'rgba(0, 255, 0, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 0, 0, 1)',
                        'rgba(0, 255, 0, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
        return monthlyIncomeExpense;
    }

    function loadSpendingAnalysis() {
        apis.getAnalysis(categoryAnalysis => {
            var analysis = document.getElementById('analysis')
            clearElement(analysis);

            if (categoryAnalysis.spendingAnalysisLineItems.length > 0) {
                analysis.hidden = false;
            } else {
                analysis.hidden = true;
            }

            categoryAnalysis.spendingAnalysisLineItems.forEach(lineItem => {
                var category = document.createElement('td');
                category.appendChild(document.createTextNode(lineItem.spendingCategory));

                var min = document.createElement('td');
                var minAmt = lineItem.min.toFixed(2);
                min.appendChild(document.createTextNode(minAmt));

                var max = document.createElement('td');
                var maxAmnt = lineItem.max.toFixed(2);
                max.appendChild(document.createTextNode(maxAmnt));

                var mean = document.createElement('td');
                var meanAmnt = lineItem.mean.toFixed(2);
                mean.appendChild(document.createTextNode(meanAmnt));

                var stddev = document.createElement('td');
                var stddevAmnt = lineItem.standardDeviation.toFixed(2);
                stddev.appendChild(document.createTextNode(stddevAmnt));

                var row = document.createElement("tr");
                row.appendChild(category);
                row.appendChild(min);
                row.appendChild(max);
                row.appendChild(mean);
                row.appendChild(stddev);

                analysis.appendChild(row);
            });
        });
    }
</script>

<div class="container">
    <h1>Transactions</h1>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Transactions</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="monthly-tab" data-toggle="tab" href="#monthly" role="tab" aria-controls="monthly" aria-selected="false">Monthly spending</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="annual-tab" data-toggle="tab" href="#annual" role="tab" aria-controls="annual" aria-selected="false">Annual spending</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active table-responsive" id="home" role="tabpanel" aria-labelledby="home-tab">
            <button id="refresh" type="button" class="btn btn-secondary">Refresh</button>
            <div id="transactionPagination">
                <nav aria-label="Page navigation">
                    <ul class="pagination" id="txPages">
                    </ul>
                </nav>
            </div>
            <table class="table table-hover table-sm">
                <thead class="thead-dark">
                <tr>
                    <th>Date</th>
                    <th>Counterparty</th>
                    <th>Amount</th>
                    <th>Currency</th>
                    <th>Category</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="transactions">
                </tbody>
            </table>
        </div>
        <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
            <label for="months">Month: </label>
            <select id="months"></select>

            <canvas id="monthlySpending" width="400" height="400"></canvas>

            <canvas id="monthlyIncomeExpense" width="400" height="400"></canvas>
        </div>
        <div class="tab-pane fade" id="annual" role="tabpanel" aria-labelledby="annual-tab">
            <table class="table table-hover table-sm">
                <thead class="thead-dark">
                <tr>
                    <th>Category</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th>Mean</th>
                    <th>Stddev</th>
                </tr>
                </thead>
                <tbody id="analysis">
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
